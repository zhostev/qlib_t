# QLib分布式管理平台技术架构文档

## 1. 系统概述
基于开源QLib开发的分布式管理平台，提供数据接入、特征管理、模型管理、模型训练及效果评估功能，支持AI量化投资策略的全流程管理。

## 2. 技术栈

### 2.1 后端技术栈
- **框架**: FastAPI (Python)
- **ORM**: SQLAlchemy
- **数据库**: MySQL (阿里云RDS)
- **实时通信**: WebSocket
- **系统监控**: psutil
- **日志**: Python logging模块

### 2.2 前端技术栈
- **框架**: Vue 3
- **语言**: TypeScript
- **构建工具**: Vite
- **包管理**: npm

### 2.3 部署环境
- **阿里云ECS**: 运行前端和后端服务
- **DDNS服务器**: 运行训练模型服务
- **阿里云RDS**: 存储系统数据

## 3. 系统架构

### 3.1 整体架构图
```
┌───────────────────────────────────────────────────────────────────┐
│                            客户端浏览器                              │
└───────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌───────────────────────────────────────────────────────────────────┐
│                           前端应用 (Vue 3)                        │
│                    /home/qlib_t/frontend                          │
└───────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌───────────────────────────────────────────────────────────────────┐
│                           后端API (FastAPI)                       │
│                    /home/qlib_t/backend                           │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │
│  │  认证   │  │  实验   │  │  模型   │  │  特征   │  │  数据   │  │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐              │
│  │  配置   │  │  基准   │  │  训练   │  │  监控   │              │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘              │
└───────────────────────────────────────────────────────────────────┘
                                   │
                   ┌───────────────┴───────────────┐
                   │                               │
                   ▼                               ▼
┌─────────────────────────────────┐   ┌─────────────────────────────────┐
│          MySQL数据库            │   │        训练服务器 (DDNS)        │
│     (阿里云RDS, qlib_ai)        │   │    /home/idea/code/qlib_t       │
└─────────────────────────────────┘   └─────────────────────────────────┘
```

### 3.2 后端架构

#### 3.2.1 目录结构
```
backend/
├── app/                  # 应用主目录
│   ├── api/              # API路由定义
│   ├── db/               # 数据库配置
│   ├── models/           # 数据库模型
│   ├── schemas/          # 数据验证模型
│   ├── services/         # 业务逻辑层
│   ├── tasks/            # 异步任务
│   ├── utils/            # 工具函数
│   └── yaml/             # YAML配置文件
├── main.py               # 应用入口
├── requirements.txt       # 依赖列表
└── .env                  # 环境配置
```

#### 3.2.2 核心模块

| 模块 | 主要功能 | 文件位置 |
|------|----------|----------|
| 认证 | 用户认证和授权 | app/api/auth.py |
| 实验 | 实验管理 | app/api/experiments.py |
| 模型 | 模型管理 | app/api/models.py |
| 配置 | 配置管理 | app/api/configs.py |
| 基准 | 基准测试 | app/api/benchmarks.py |
| 特征 | 特征管理 | app/api/factors.py |
| 数据 | 数据管理 | app/api/data.py |
| 训练 | 模型训练 | app/api/train.py |

#### 3.2.3 API路由

| 路由前缀 | 模块 | 标签 |
|----------|------|------|
| /api/auth | 认证 | auth |
| /api/experiments | 实验 | experiments |
| /api/models | 模型 | models |
| /api/configs | 配置 | configs |
| /api/benchmarks | 基准 | benchmarks |
| /api/factors | 特征 | factors |
| /api/data | 数据 | data |
| /api/train | 训练 | train |

### 3.3 前端架构

#### 3.3.1 目录结构
```
frontend/
├── dist/                 # 构建输出目录
├── src/                  # 源代码目录
├── index.html            # HTML入口
├── package.json          # 项目配置
└── vite.config.js        # Vite配置
```

## 4. 核心功能流程

### 4.1 模型训练流程
1. 用户通过前端创建训练任务
2. 后端接收训练请求，创建实验记录
3. 后端调用训练服务器API发起训练
4. 训练服务器执行模型训练
5. 训练过程中通过WebSocket实时返回日志和状态
6. 训练完成后，后端更新实验状态，存储模型结果
7. 前端展示训练结果和评估指标

### 4.2 数据处理流程
1. 数据接入模块从数据源获取原始数据
2. 数据处理模块进行数据清洗、转换
3. 特征工程模块生成特征
4. 处理后的数据存储到数据库
5. 模型训练时从数据库读取数据

## 5. 系统配置

### 5.1 环境变量配置 (.env)
```
DATABASE_URL=mysql+pymysql://username:password@host:port/qlib_ai
SECRET_KEY=your-secret-key-here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
TRAINING_SERVER_URL=http://ddns.hoo.ink:8000
TRAINING_SERVER_TIMEOUT=3600
```

### 5.2 CORS配置
允许以下来源访问API：
- http://localhost:3000
- http://localhost:3001
- http://localhost:5173
- http://116.62.59.244
- http://qlib.hoo.ink
- http://ddns.hoo.ink:8000

## 6. 系统监控与日志

### 6.1 监控端点
- **健康检查**: `/health` - 返回系统健康状态
- **系统状态**: `/status` - 返回CPU、内存、磁盘使用情况

### 6.2 日志配置
- 日志级别: INFO
- 日志格式: `%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s`
- 输出位置: 控制台和文件(uvicorn.log)
- 慢请求日志: 记录处理时间超过1秒的请求

### 6.3 WebSocket实时监控
- 端点: `/ws/train/{task_id}`
- 功能: 实时推送训练日志和状态更新

## 7. 部署架构

### 7.1 阿里云环境部署
- **前端**: 部署在阿里云ECS，使用Nginx提供静态文件服务
- **后端**: 部署在阿里云ECS，使用FastAPI + Uvicorn运行
- **数据库**: 阿里云RDS MySQL实例
- **训练服务**: 部署在DDNS服务器上，通过HTTP API与后端通信

### 7.2 服务管理
- 使用Supervisor管理后端服务和训练worker
- 配置文件: `backend_supervisor.conf`, `supervisor_train_worker.conf`

## 8. 安全设计

### 8.1 认证与授权
- 使用JWT进行用户认证
- 密码哈希存储
- 基于角色的访问控制

### 8.2 API安全
- CORS限制允许的来源
- 请求验证和参数校验
- 异常处理和错误信息脱敏

### 8.3 数据安全
- 数据库连接加密
- 敏感数据加密存储
- 定期数据备份

## 9. 扩展性设计

### 9.1 模块化架构
- 采用模块化设计，各功能模块解耦
- 支持独立部署和扩展

### 9.2 分布式训练
- 训练服务独立部署，支持水平扩展
- 支持多任务并行训练

### 9.3 API设计
- RESTful API设计，支持版本控制
- 支持异步操作和实时通信

## 10. 技术亮点

1. **全流程管理**: 从数据接入到模型部署的完整AI量化投资策略管理
2. **实时监控**: WebSocket实时推送训练日志和状态
3. **模块化设计**: 功能模块解耦，易于扩展和维护
4. **分布式架构**: 训练服务独立部署，支持水平扩展
5. **完善的监控体系**: 提供健康检查、系统状态监控和慢请求日志
6. **安全可靠**: 实现了认证授权、API安全和数据安全

## 11. 未来规划

1. **支持更多模型**: 扩展支持更多机器学习和深度学习模型
2. **自动化调参**: 实现模型超参数自动优化
3. **模型部署服务**: 提供模型在线部署和推理服务
4. **多数据源支持**: 支持更多数据源接入
5. **可视化分析**: 增强数据和结果可视化分析能力
6. **团队协作功能**: 支持多用户协作和权限管理

# 优化点识别与问题排查计划

## 1. 优化点识别

### 1.1 性能优化
- **数据库查询优化**: 分析慢查询，添加适当索引
- **API响应优化**: 优化数据序列化和传输
- **训练效率优化**: 优化训练算法和资源利用

### 1.2 可靠性优化
- **错误处理增强**: 完善异常处理和错误恢复机制
- **服务冗余**: 考虑关键服务的冗余部署
- **数据备份策略**: 完善数据备份和恢复机制

### 1.3 安全性优化
- **漏洞扫描**: 定期进行安全漏洞扫描
- **访问控制细化**: 增强基于角色的访问控制
- **日志审计**: 完善日志审计功能

### 1.4 易用性优化
- **API文档完善**: 增强API文档的可读性和完整性
- **前端交互优化**: 提升用户体验
- **监控界面增强**: 提供更直观的监控界面

## 2. 问题排查计划

### 2.1 系统状态检查
- 检查服务运行状态
- 检查数据库连接
- 检查训练服务器连接

### 2.2 日志分析
- 分析后端日志
- 分析训练日志
- 分析数据库日志

### 2.3 功能测试
- 测试各API端点
- 测试模型训练流程
- 测试数据处理流程
- 测试WebSocket实时通信

### 2.4 性能测试
- 测试API响应时间
- 测试并发处理能力
- 测试训练性能

## 3. 全面联调与测试计划

### 3.1 单元测试
- 对关键函数和模块进行单元测试
- 确保代码质量和功能正确性

### 3.2 集成测试
- 测试各模块之间的集成
- 测试前后端集成
- 测试后端与训练服务器集成

### 3.3 端到端测试
- 测试完整业务流程
- 测试边界情况
- 测试异常情况

### 3.4 性能测试
- 负载测试
- 压力测试
- 稳定性测试

### 3.5 安全测试
- 渗透测试
- 漏洞扫描
- 安全审计

# 详细问题列表

## 1. 已发现问题

### 1.1 配置问题
- **问题**: SECRET_KEY使用默认值，存在安全风险
- **影响**: 可能导致JWT令牌被破解
- **建议**: 生成随机强密钥并更新配置

### 1.2 日志问题
- **问题**: 日志文件路径使用相对路径，可能导致日志文件位置不确定
- **影响**: 日志管理困难，可能导致磁盘空间问题
- **建议**: 使用绝对路径存储日志文件

### 1.3 CORS配置问题
- **问题**: CORS允许多个来源，包括多个本地开发环境
- **影响**: 在生产环境中存在安全风险
- **建议**: 生产环境中只允许特定的前端域名

### 1.4 训练服务器连接问题
- **问题**: 训练服务器连接超时设置为1小时，可能导致长时间等待
- **影响**: 影响用户体验，可能导致请求超时
- **建议**: 优化训练服务器性能，或调整超时设置

### 1.5 数据库连接问题
- **问题**: 数据库连接配置直接写在环境变量中，存在安全风险
- **影响**: 可能导致数据库凭证泄露
- **建议**: 使用更安全的方式管理数据库凭证

### 1.6 测试文件管理问题
- **问题**: 项目中存在多个测试文件，可能导致测试混乱
- **影响**: 测试维护困难，可能导致测试覆盖不全
- **建议**: 统一测试文件管理，完善测试用例

### 1.7 WebSocket连接问题
- **问题**: WebSocket连接需要客户端发送消息保持连接，可能导致连接不稳定
- **影响**: 实时日志和状态更新可能中断
- **建议**: 优化WebSocket连接管理，添加心跳机制

### 1.8 系统监控问题
- **问题**: 系统状态监控只提供基础信息，缺乏更详细的监控指标
- **影响**: 难以定位系统性能瓶颈
- **建议**: 增强系统监控，添加更多监控指标

### 1.9 错误处理问题
- **问题**: 异常处理返回的错误信息不够详细，不利于调试
- **影响**: 开发和调试困难
- **建议**: 完善错误信息，提供更详细的调试信息

### 1.10 代码结构问题
- **问题**: 部分代码结构不够清晰，存在重复代码
- **影响**: 代码维护困难，容易引入bug
- **建议**: 重构代码，优化代码结构

## 2. 待排查问题

### 2.1 功能完整性问题
- 检查各功能模块是否完整实现
- 检查是否存在功能缺失

### 2.2 性能问题
- 检查API响应时间
- 检查数据库查询性能
- 检查训练效率

### 2.3 可靠性问题
- 检查服务稳定性
- 检查错误恢复机制
- 检查数据一致性

### 2.4 安全问题
- 检查认证授权机制
- 检查API安全配置
- 检查数据安全措施

### 2.5 兼容性问题
- 检查浏览器兼容性
- 检查不同环境下的兼容性

### 2.6 可扩展性问题
- 检查系统扩展性设计
- 检查是否支持水平扩展

# 总结

QLib分布式管理平台采用了先进的技术架构，实现了从数据接入到模型部署的完整AI量化投资策略管理流程。系统具有模块化设计、分布式架构、实时监控和完善的安全机制等技术亮点。

通过本次技术架构分析，我们识别了一些优化点和问题，包括配置问题、日志问题、CORS配置问题、训练服务器连接问题、数据库连接问题、测试文件管理问题、WebSocket连接问题、系统监控问题、错误处理问题和代码结构问题。

针对这些问题，我们提出了详细的优化建议和排查计划，包括性能优化、可靠性优化、安全性优化、易用性优化等方面。通过实施这些优化和排查，将有助于提高系统的性能、可靠性、安全性和易用性，为用户提供更好的服务。

未来，我们将继续完善系统功能，支持更多模型、实现自动化调参、提供模型部署服务、支持多数据源和增强可视化分析能力，进一步提升系统的竞争力和价值。