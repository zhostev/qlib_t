# 实现模型训练任务与本地服务器后端解耦

## 1. 系统分析
当前系统采用前后端分离架构，后端使用FastAPI实现，前端使用TypeScript。模型训练流程通过任务队列机制实现，任务执行器定期检查待处理任务并执行。

## 2. 目标
将模型训练任务与本地服务器后端解耦，在DDNS服务器（ddns.hoo.ink:8000）上执行训练任务，同时保持前端能够正常触发和监控训练过程。

## 3. 实施步骤

### 3.1 配置管理
- **修改后端配置文件**：添加DDNS服务器连接信息
- **创建配置加载模块**：支持从环境变量或配置文件读取DDNS服务器信息

### 3.2 任务调度机制修改
- **修改任务创建逻辑**：支持将训练任务发送到DDNS服务器
- **实现远程任务提交API**：在本地后端添加远程任务提交接口
- **修改任务执行器**：支持从DDNS服务器接收和执行任务

### 3.3 DDNS服务器部署
- **部署训练执行器**：在DDNS服务器上部署模型训练执行器
- **配置数据库连接**：确保DDNS服务器能够连接到MySQL数据库
- **安装依赖**：在DDNS服务器上安装必要的依赖包

### 3.4 通信机制实现
- **实现任务状态同步**：确保DDNS服务器上的训练状态能够同步到本地数据库
- **实现结果返回机制**：确保训练结果能够正确返回给本地后端
- **添加错误处理**：处理远程通信中的各种异常情况

### 3.5 前端适配
- **修改前端API调用**：确保前端能够正确触发远程训练
- **更新状态监控**：确保前端能够实时监控DDNS服务器上的训练状态
- **添加错误提示**：在远程训练失败时提供友好的错误提示

### 3.6 测试与调试
- **单元测试**：测试各个组件的功能
- **集成测试**：测试整个系统的协作
- **联调测试**：确保前后端与DDNS服务器能够正常通信

## 4. 关键文件修改

### 后端文件
- `/home/qlib_t/backend/app/config.py`：添加DDNS服务器配置
- `/home/qlib_t/backend/app/services/task.py`：修改任务创建和管理逻辑
- `/home/qlib_t/backend/app/tasks/task_worker.py`：修改任务执行器，支持远程任务
- `/home/qlib_t/backend/app/api/experiments.py`：修改实验运行API，支持远程训练

### 前端文件
- `/home/qlib_t/frontend/src/services/experiments.ts`：修改实验服务，支持远程训练调用

### 新增文件
- `/home/qlib_t/backend/app/services/remote_train.py`：远程训练服务
- `/home/qlib_t/backend/app/utils/remote_client.py`：DDNS服务器客户端

## 5. 预期效果
- 前端能够通过现有API触发模型训练
- 训练任务在DDNS服务器上执行
- 训练状态和结果能够实时同步到本地系统
- 系统具有良好的错误处理和容错能力

## 6. 风险评估
- **网络延迟**：可能导致任务提交和状态更新延迟
- **DDNS服务器稳定性**：需要确保DDNS服务器能够稳定运行
- **数据一致性**：需要确保本地数据库和DDNS服务器之间的数据一致性
- **安全性**：需要确保远程通信的安全性

## 7. 安全措施
- 使用HTTPS进行远程通信
- 实现身份验证和授权机制
- 对敏感数据进行加密传输
- 添加请求频率限制

## 8. 后续优化
- 实现任务优先级管理
- 添加任务调度策略
- 实现训练资源监控
- 添加自动重试机制

## 9. 测试计划
- 测试远程任务提交功能
- 测试训练状态同步
- 测试结果返回机制
- 测试错误处理
- 测试系统稳定性

## 10. 部署计划
- 配置DDNS服务器环境
- 部署训练执行器
- 测试远程通信
- 逐步切换到远程训练模式